#!/usr/bin/env python3
# ruff: noqa: E501

import sys
import datetime
import re
#import os
#from decimal import Decimal
#from pathlib import Path

mondir = [0,
        '01_Jan','02_Feb','03_Mar','04_Apr','05_May','06_Jun',
        '07_Jul','08_Aug','09_Sep','10_Oct','11_Nov','12_Dec']
oneday = datetime.timedelta(days=1)

def splitym(ym):
    """Split string yyyy-mm into ints (yyyy, mm)"""
    y, m = ym.translate(str.maketrans('-_/', '   ')).split()
    return int(y), int(m)

def calcudate(args, ym=None):
    def pday(juncture):
        """Previous day before juncture"""
        return juncture+datetime.timedelta(days=-1)
    def nday(juncture):
        """Next day after juncture"""
        return juncture+datetime.timedelta(days=1)
    def bom(juncture):
        """Beginning of month containing juncture"""
        return juncture.replace(day=1)
    def eom(juncture):
        """End of month containing juncture"""
        return pday(bom(bom(juncture)+datetime.timedelta(days=31)))
    def next(juncture):
        """Same day next month"""
        return nday(eom(juncture)).replace(day=juncture.day)
    def prev(juncture):
        """Same day prev month"""
        return pday(bom(juncture)).replace(day=juncture.day)
    juncture = datetime.date.today()
    if ym:
        y, m = splitym(ym)
        ymdate = datetime.date(y, m, 1)
    else:
        ymdate = juncture.replace(day=1)
    for arg in args.split() if isinstance(args, str) else args:
        if m := re.match(r"(\d\d\d\d)-(\d\d)-(\d\d)", arg):
            juncture = datetime.date(int(m[1]), int(m[2]), int(m[3]))
        elif m := re.match(r"(\d\d\d\d)[-/_](\d\d)", arg):
            juncture = datetime.date(int(m[1]), int(m[2]), 1)
        elif m := re.match(r"(\d\d?)", arg):
            juncture = juncture.replace(day=int(m[1]))
        elif arg == 'ym':
            juncture = ymdate
        elif arg in ['today', 'now']:
            juncture = datetime.date.today()
        elif arg == 'bom':
            juncture = bom(juncture)
        elif arg == 'eom':
            juncture = eom(juncture)
        elif arg == 'next':
            juncture = next(juncture)
        elif arg == 'prev':
            juncture = prev(juncture)
        elif arg == 'nday':
            juncture = nday(juncture)
        elif arg == 'pday':
            juncture = pday(juncture)
    return juncture

if not sys.argv[1:] or sys.argv[1] in ['-?', '-h', '--help']:
    print("usage: calcudate {YM DATE DAY bom eom next prev nday pday}...", file=sys.stderr)
    sys.exit(1)
print(calcudate(sys.argv[1:]))
